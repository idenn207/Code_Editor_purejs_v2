<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autocomplete Test Runner</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }

    .controls {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #results {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 200px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #666;
    }

    .loading::before {
      content: "";
      width: 20px;
      height: 20px;
      border: 2px solid #ddd;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state p {
      margin: 0;
      font-size: 16px;
    }
  </style>
  <style id="reporter-styles"></style>
</head>
<body>
  <div class="header">
    <h1>Autocomplete Test Runner</h1>
    <div class="controls">
      <button id="runAll" class="btn btn-primary">Run All Tests</button>
      <button id="runUnit" class="btn btn-secondary">Unit Only</button>
      <button id="runIntegration" class="btn btn-secondary">Integration Only</button>
      <button id="runE2E" class="btn btn-secondary">E2E Only</button>
    </div>
  </div>

  <div id="results">
    <div class="empty-state">
      <p>Click "Run All Tests" to start testing</p>
    </div>
  </div>

  <!-- Test Framework -->
  <script src="framework/TestRunner.js"></script>
  <script src="framework/Expect.js"></script>
  <script src="framework/TestReporter.js"></script>

  <!-- Source Files (Autocomplete modules) -->
  <script src="../src/features/autocomplete/types/TypeKind.js"></script>
  <script src="../src/features/autocomplete/types/Type.js"></script>
  <script src="../src/features/autocomplete/types/PrimitiveType.js"></script>
  <script src="../src/features/autocomplete/types/ObjectType.js"></script>
  <script src="../src/features/autocomplete/types/ArrayType.js"></script>
  <script src="../src/features/autocomplete/types/FunctionType.js"></script>
  <script src="../src/features/autocomplete/types/ClassType.js"></script>
  <script src="../src/features/autocomplete/types/UnionType.js"></script>
  <script src="../src/features/autocomplete/types/TypeVariable.js"></script>
  <script src="../src/features/autocomplete/types/GenericType.js"></script>
  <script src="../src/features/autocomplete/types/TypeSubstitution.js"></script>
  <script src="../src/features/autocomplete/types/BuiltinTypes.js"></script>
  <script src="../src/features/autocomplete/symbols/SymbolKind.js"></script>
  <script src="../src/features/autocomplete/symbols/Symbol.js"></script>
  <script src="../src/features/autocomplete/symbols/Scope.js"></script>
  <script src="../src/features/autocomplete/symbols/ScopeManager.js"></script>
  <!-- Parser -->
  <script src="../src/features/autocomplete/parser/SimpleTokenizer.js"></script>
  <script src="../src/features/autocomplete/parser/ExpressionNode.js"></script>
  <script src="../src/features/autocomplete/parser/ExpressionParser.js"></script>
  <!-- Inference -->
  <script src="../src/features/autocomplete/inference/ReturnTypeAnalyzer.js"></script>
  <script src="../src/features/autocomplete/inference/GenericInference.js"></script>
  <script src="../src/features/autocomplete/inference/TypeInferenceEngine.js"></script>
  <script src="../src/features/autocomplete/inference/ClassTypeBuilder.js"></script>
  <script src="../src/features/autocomplete/inference/ThisContextTracker.js"></script>
  <!-- TypeChecker -->
  <script src="../src/features/autocomplete/TypeChecker.js"></script>

  <!-- Unit Tests - Set category before loading -->
  <script>TestRunner.setCategory('unit');</script>
  <!-- Unit Tests - Types (Phase 1) -->
  <script src="unit/types/TypeKind.test.js"></script>
  <script src="unit/types/Type.test.js"></script>
  <script src="unit/types/PrimitiveType.test.js"></script>
  <script src="unit/types/ObjectType.test.js"></script>
  <script src="unit/types/ArrayType.test.js"></script>
  <script src="unit/types/FunctionType.test.js"></script>
  <script src="unit/types/ClassType.test.js"></script>
  <script src="unit/types/UnionType.test.js"></script>
  <script src="unit/types/TypeVariable.test.js"></script>
  <script src="unit/types/GenericType.test.js"></script>

  <!-- Unit Tests - Symbols (Phase 2) -->
  <script src="unit/symbols/SymbolKind.test.js"></script>
  <script src="unit/symbols/Symbol.test.js"></script>
  <script src="unit/symbols/Scope.test.js"></script>
  <script src="unit/symbols/ScopeManager.test.js"></script>

  <!-- Unit Tests - Parser -->
  <script src="unit/parser/ExpressionParser.test.js"></script>

  <!-- Integration Tests - Set category before loading -->
  <script>TestRunner.setCategory('integration');</script>
  <script src="integration/TypeSystem.test.js"></script>
  <script src="integration/SymbolTable.test.js"></script>
  <script src="integration/ScopeResolution.test.js"></script>
  <script src="integration/TypeInference.test.js"></script>

  <!-- E2E Tests - Set category before loading -->
  <script>TestRunner.setCategory('e2e');</script>
  <script src="e2e/AutocompleteWorkflow.test.js"></script>
  <script src="e2e/CodeAnalysis.test.js"></script>

  <!-- Reset category after all test files loaded -->
  <script>TestRunner.setCategory(null);</script>

  <script>
    // Inject reporter styles
    document.getElementById('reporter-styles').textContent = TestReporter.getStyles();

    var resultsContainer = document.getElementById('results');
    var runAllBtn = document.getElementById('runAll');
    var runUnitBtn = document.getElementById('runUnit');
    var runIntegrationBtn = document.getElementById('runIntegration');
    var runE2EBtn = document.getElementById('runE2E');

    // Track last results for filtering
    var lastResults = null;

    function showLoading() {
      resultsContainer.innerHTML = '<div class="loading">Running tests...</div>';
    }

    function updateActiveButton(activeBtn) {
      [runAllBtn, runUnitBtn, runIntegrationBtn, runE2EBtn].forEach(function(btn) {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      });
      activeBtn.classList.remove('btn-secondary');
      activeBtn.classList.add('btn-primary');
    }

    function runTestsWithFilter(filter, activeBtn) {
      showLoading();
      updateActiveButton(activeBtn);
      TestRunner.setFilter(filter);

      // Use setTimeout to allow UI to update
      setTimeout(function() {
        try {
          var results = TestRunner.run();
          lastResults = results;
          TestReporter.render(results, resultsContainer);
        } catch (error) {
          resultsContainer.innerHTML =
            '<div class="result-error" style="margin: 20px;">' +
            '<div class="error-message">Test runner error: ' + error.message + '</div>' +
            '<pre class="error-stack">' + error.stack + '</pre>' +
            '</div>';
        }
      }, 50);
    }

    runAllBtn.addEventListener('click', function() {
      runTestsWithFilter('all', runAllBtn);
    });

    runUnitBtn.addEventListener('click', function() {
      runTestsWithFilter('unit', runUnitBtn);
    });

    runIntegrationBtn.addEventListener('click', function() {
      runTestsWithFilter('integration', runIntegrationBtn);
    });

    runE2EBtn.addEventListener('click', function() {
      runTestsWithFilter('e2e', runE2EBtn);
    });

    // Auto-run on page load (optional)
    // window.addEventListener('load', function() { runTestsWithFilter('all', runAllBtn); });
  </script>
</body>
</html>
